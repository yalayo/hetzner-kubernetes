name: Infrastructure

on:
  push:
    branches: [ master ]
  # workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  NIX_PATH: nixpkgs=channel:nixos-24.11

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest

    outputs:
      plan_has_changes: ${{ steps.detect.outputs.has_changes }}

    steps:
      - uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v10
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Terraform Init & Plan
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          TF_VAR_ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          TF_VAR_k3s_token: ${{ secrets.K3S_TOKEN }}
        run: |
          set -euo pipefail
          cd terraform
          terraform init
          terraform plan -target hcloud_server.cicd -out=tfplan
          terraform show -no-color tfplan > plan.txt
          terraform show -json tfplan > plan.json

      - name: Detect Terraform changes
        id: detect
        run: |
          set -euo pipefail
          cd terraform

          #CHANGES=$(jq '
          #  [.resource_changes[]
          #  | select(.change.actions | any(. != "no-op"))
          #  ] | length
          #' plan.json)

          ls -lh plan.json
          head -c 1 plan.json | cat -A
          jq empty plan.json
          #jq '.resource_changes | length' plan.json

          echo "Plan JSON"
          jq '[.resource_changes[] | select(.change.actions | any(. != "no-op"))]' plan.json

          if [ "$CHANGES" -gt 0 ]; then
            echo "Changes detected: $CHANGES"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "No changes detected"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload Terraform plan
        if: steps.detect.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: |
            terraform/tfplan
            terraform/plan.txt
            terraform/plan.json

  terraform-apply:
    name: Terraform Apply (manual approval)
    runs-on: ubuntu-latest
    needs: terraform-plan

    # Correct gating condition
    if: needs.terraform-plan.outputs.plan_has_changes == 'true'

    # This guarantees the job WAITS for approval
    environment:
      name: infra-approval

    steps:
      - uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v10
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Download approved plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: terraform

      - name: Show approved plan
        run: cat terraform/plan.txt