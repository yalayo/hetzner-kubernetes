name: Kubernetes Cluster - production

on:
  #push:
    #branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  NIX_PATH: nixpkgs=channel:nixos-24.11

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest

    outputs:
      plan_has_changes: ${{ steps.detect.outputs.has_changes }}

    steps:
      - uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v10
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Terraform Init & Plan
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          TF_VAR_ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          TF_VAR_k3s_token: ${{ secrets.K3S_TOKEN }}
        run: |
          set -euo pipefail
          cd terraform
          terraform init
          terraform plan -target hcloud_server.node -out=tfplan
          terraform show -no-color tfplan > plan.txt

      - name: Detect Terraform changes (from plan.txt)
        id: detect
        run: |
          set -euo pipefail
          cd terraform

          PLAN_LINE=$(grep -E '^Plan:' plan.txt || true)

          echo "Terraform plan summary:"
          echo "$PLAN_LINE"

          if echo "$PLAN_LINE" | grep -Eq 'Plan: [1-9][0-9]* to (add|change|destroy)'; then
            echo "Changes detected"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "No changes detected"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload Terraform plan
        if: steps.detect.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: |
            terraform/tfplan
            terraform/plan.txt

      - name: ðŸ§¾ Terraform plan (job summary)
        if: steps.detect.outputs.has_changes == 'true'
        run: |
          {
            echo "## Terraform Plan"
            echo ""
            echo "**Summary:** $(grep '^Plan:' terraform/plan.txt)"
            echo ""
            echo '```'
            cat terraform/plan.txt
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"


  terraform-apply:
    name: Terraform Apply (manual approval)
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: needs.terraform-plan.outputs.plan_has_changes == 'true'

    environment:
      name: infra-approval

    steps:
      - uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Download approved plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: terraform

      - name: Terraform Apply & Outputs
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          TF_VAR_ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          TF_VAR_k3s_token: ${{ secrets.K3S_TOKEN }}
        run: |
            cd ./terraform
            terraform init

            terraform apply -target hcloud_server.node -auto-approve

            terraform output -json nodes_ips | awk '
            BEGIN { depth=0; started=0 }
            {
              for (i=1; i<=length($0); i++) {
                c=substr($0,i,1)
                if (c=="{") {
                  depth++
                  started=1
                }
                if (started) printf "%s", c
                if (c=="}") {
                  depth--
                  if (started && depth==0) {
                    print ""
                    exit
                  }
                }
              }
              if (started) print ""
            }
            ' > ../nodes.json

            # We need the nodes public ips instead of the private ips
            terraform output -json nodes_ips | awk '
            BEGIN { depth=0; started=0 }
            {
              for (i=1; i<=length($0); i++) {
                c=substr($0,i,1)
                if (c=="{") {
                  depth++
                  started=1
                }
                if (started) printf "%s", c
                if (c=="}") {
                  depth--
                  if (started && depth==0) {
                    print ""
                    exit
                  }
                }
              }
              if (started) print ""
            }
            ' > ../terraform.json

      - name: Upload Terraform outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-data
          path: |
            terraform.json
            nodes.json

  colmena-apply:
    name: Colmena Apply (Configure k3s)
    runs-on: ubuntu-latest
    needs: terraform-apply

    steps:
      - uses: actions/checkout@v3

      - name: Download Terraform outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-data
          path: k3s-colmena

      # ðŸ”‘ THIS IS THE FIX
      - name: Commit terraform.json for Colmena
        run: |
          set -e
          cd k3s-colmena

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add terraform.json nodes.json
          git commit -m "ci: update terraform outputs for colmena" || echo "Nothing to commit"

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v10
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Install Colmena
        run: nix profile install nixpkgs#colmena

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          jq -r 'to_entries[].value' k3s-colmena/nodes.json | while read ip; do
            ssh-keyscan -H "$ip" >> ~/.ssh/known_hosts
          done

      - name: Colmena apply
        env:
          K3S_TOKEN: ${{ secrets.K3S_TOKEN }}
        run: |
          cd k3s-colmena
          echo "Hive generated:"
          nix-instantiate --eval --expr 'import ./hive.nix'
          echo "Hosts:"
          colmena query --config ./flake.nix
          colmena apply --impure --config ./flake.nix --on @all
